<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>交易界面</title>
    <script src="highstock.js"></script>
    <script src="exporting.js"></script>
    <script src="export-data.js"></script>
    <script src="accessibility.js"></script>
    <style>

        @keyframes fadeIn {
            0% {
                opacity: 0;
            }
            100% {
                opacity: 0.9;
            }
        }

        @keyframes fadeOut {
            0% {
                opacity: 0.9;
            }
            100% {
                opacity: 0;
            }
        }

        /* 保留原有的 fadeInZoom 和 fadeOutZoom 動畫規則 */
        @keyframes fadeInZoom {
            0% {
                opacity: 0;
                transform: scale(0.8);
            }
            100% {
                opacity: 0.9;
                transform: scale(1);
            }
        }

        @keyframes fadeOutZoom {
            0% {
                opacity: 0.9;
                transform: scale(1);
            }
            100% {
                opacity: 0;
                transform: scale(0.8);
            }
        }


        

        .header {
            position: absolute;
            top: 20px;
            left: 22px;
            font-size: 1.4em;
            color: #333;
        }
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #ffffff;
            color: #333;
            margin: 0;
            position: relative;
            height: 100%; /* 調整高度 */
            width: 100%; /* 調整寬度 */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .constum-body {
            font-family: 'Roboto', sans-serif;
            background-color: #f4f4f9;
            color: #333;
            margin: 0;
            position: relative;
            height: 100%; /* 調整高度 */
            width: 100%; /* 調整寬度 */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        
        .container {
            width: 95%;
            margin: 0 auto;
            text-align: center;
            position: relative;
            z-index: 0; /* 確保內容在背景 */
            padding-top: 0px; /* 增加填充確保內容不遮擋標題和按鈕 */
        }

        .areachart {
            width: 95%;
            margin: 0 auto;
            text-align: center;
            position: relative;
            z-index: 0; /* 確保內容在背景 */
            padding-top: 40px; /* 增加填充確保內容不遮擋標題和按鈕 */
        }


        /* 針對手機平板 */
        @media only screen and (max-width: 992px) {
            .register-button {
                top: 25px;
                right: 46px;
            }
            .login-button {
                top: 22px;
                right: 12px;
            }
            .intro-button {
                top: 25px;
                right: 12px;
            }
            .order-button {
                top: 25px;
                right: 130px;
            }
            .inventory-button {
                top: 25px;
                right: 85px;
            }
        }

        /* 針對桌面 */
        @media only screen and (min-width: 993px) {
            .register-button {
                top: 25px;
                right: 70px;
            }
            .login-button {
                top: 24px;
                right: 25px;
            }
            .intro-button {
                top: 25px;
                right: 25px;
            }
            .order-button {
                top: 25px;
                right: 190px;
            }
            .inventory-button {
                top: 25px;
                right: 130px;
            }
        }
        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 1em;
            color: #333;
        }

        .form-group input {
            width: 100%;
            padding: 10px;
            font-size: 1em;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
            outline: none;
        }

        .form-group button {
            width: 100%;
            padding: 10px;
            font-size: 1em;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            background-color: #000;
            color: #fff;
            transition: box-shadow 0.2s ease;
            outline: none;
        }
        .message {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 10px;
            border-radius: 15px;
            color: #fff;
            opacity: 1;
            transition: opacity 1s ease-out;
        }

        .intro-button {
            position: absolute;
            font-size: 1em;
            color: #aaa;
            cursor: pointer;
            background: none;
            border: none;
            outline: none;
        }

        .register-button,
        .inventory-button,
        .order-button {
            position: absolute;
            font-size: 1em;
            color: #aaa;
            cursor: pointer;
            background: none;
            border: none;
            outline: none;
            z-index: 1000; /* 增加這行 */
        }


        .login-button {
            position: absolute;
            font-size: 1em;
            color: #fff;
            background: #000;
            border: none;
            border-radius: 6px;
            padding: 3px 6px;
            cursor: pointer;
            outline: none;
            z-index: 1000; /* 增加這行 */
        }

        .register-modal,
        .login-modal {
            position: fixed;
            top: 27%;
            transform: translate(-50%, -50%);
            background: #fff;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            width: 80%;
            text-align: left;
            animation: fadeInZoom 0.5s forwards;
            z-index: 10;
            display: none;
            z-index: 2000; /* 增加這行 */
        }

        .cashout-info,
        .alert-info {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.5);
            padding: 5px 10px;
            border-radius: 15px;
            color: #fff;
            opacity: 1;
            transition: opacity 1s ease-out;
        }

        .alert-info {
            background: rgba(255, 0, 0, 0.7);
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.2em;
            cursor: pointer;
            color: #000;
            position: absolute;
            top: 10px;
            right: 10px;
        }

        .button {
            background-color: #f0f0f0;
            border: none;
            padding: 10px 20px;
            margin: 5px 0;
            cursor: pointer;
            border-radius: 5px;
            display: block;
            width: 100%;
            box-sizing: border-box;
            color: black;
            font-size: 16px;
        }

        .balance {
            margin-left: auto; /* 右對齊 */
            font-size: 16px;
        }


        .button-leverage {
            background-color: #f0f0f0;
            border: none;
            padding: 10px 20px;
            margin: 5px 0;
            cursor: pointer;
            border-radius: 5px;
            display: block;
            width: 30%;
            box-sizing: border-box;
            color: black;
            font-size: 16px;
        }

        .button-row {
            display: flex;
            justify-content: space-between;
        }

        .button-row .button {
            width: 48%;
        }


        .toggle-button {
            display: flex;
            position: relative;
            margin: 5px 0;
            height: 40px;
            background-color: #f0f0f0;
            border-radius: 5px;
        }
        .toggle-button button {
            width: 50%;
            z-index: 1;
            position: relative;
            background-color: transparent;
            border: none;
            padding: 10px 25px;
            cursor: pointer;
            font-size: 16px;
            color: black;
        }
        .stock-info {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            max-width: 100%;
        }
        .stock-number {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }
        .current-stock {
            background-color: #000000;
            color: white;
            padding: 3px 6px;
            border-radius: 15px;
            font-size: 14px;
            margin-right: 10px;
        }
        .stock-name {
            font-size: 16px;
            color: #666;
        }
        .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        .info-label {
            color: #666;
        }
        .info-value {
            font-weight: bold;
        }
        .profit {
            font-weight: bold;
        }
        
        .slider {
            position: absolute;
            top: 5%;
            height: 90%;
            background-color: #fff;
            border-radius: 5px;
            transition: 0.4s;
        }
        .margin-slider {
            width: 31.33333333333%;
            left: 1%;
        }
        .toggle-button.active .margin-slider {
            left: 50%;
        }
        .stock-slider {
            width: 46%;
            left: 2%;
        }
        .toggle-button.active .stock-slider {
            left: 50%;
        }
        .button-buy {
            background-color: #4caf50;
            color: white;
        }
        .button-sell {
            background-color: #f44336;
            color: white;
        }
        .price-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 10px 0;
        }
        .price-control, .quantity-control {
            display: flex;
            align-items: center;
            border: 1px solid #ccc;
            border-radius: 5px;
            overflow: hidden;
            width: 48%;
        }
        .price-control button, .quantity-control button {
            background-color: #fff;
            border: none;
            padding: 5px;
            font-size: 25px;
            cursor: pointer;
            color: black;
            width: 20%;
        }
        .price-control input, .quantity-control input {
            text-align: center;
            border: none;
            font-size: 20px;
            background-color: #fff;
            margin: 0;
            padding: 10px 0;
            width: 60%;
        }
        .quantity-control span {
            font-size: 12px;
            color: #999;
        }
        .info {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            font-size: 16px;
            width: 100%; /* 確保整行佔滿寬度 */
        }
        .chart {
            height: 400px;
            margin: 20px 0 0 0;
            font-size: 16px;
        }
        /* 視窗樣式 */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            align-items: center;
            justify-content: center;
            z-index: 2;
            opacity: 0;
            z-index: 2000; /* 增加這行 */
            transition: opacity 0.3s; /* 將 transition 時間設置為 0.3s */
        }
        .modal.show {
            display: flex;
            opacity: 1;
        }
        .modal-leverage {
            background-color: white;
            border-radius: 15px;
            width: 85%;
            padding: 20px;
            text-align: center;
            position: relative;
        }
        .modal-content {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            max-width: 500px;
            width: 80%;
            max-height: 80%; /* 限制視窗高度 */
            overflow-y: auto; /* 內容可滾動 */
            position: relative;
            animation: fadeInZoom 0.5s forwards;
        }
        .close {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 24px;
            cursor: pointer;
            color: black;
        }
        .control-btn {
            font-size: 24px;
            padding: 5px 15px;
            margin: 0 10px;
            border: none;
            background-color: #f0f0f0;
            cursor: pointer;
            color: black;
            border-radius: 5px;
        }
        .multipliers {
            display: flex;
            overflow-x: scroll;
            margin: 20px 0;
            scrollbar-width: none; /* Firefox */
        }
        .multipliers::-webkit-scrollbar {
            display: none; /* Safari and Chrome */
        }
        .multiplier {
            padding: 10px;
            margin: 0 5px;
            cursor: pointer;
            white-space: nowrap;
            transition: background-color 0.3s, color 0.3s;
            border-radius: 10px; /* 保持圓角 */
        }
        .selected {
            background-color: black;
            color: white;
        }
        .confirm-btn {
            font-size: 18px;
            color: white;
            background-color: black;
            border: none;
            padding: 10px 60px;
            border-radius: 20px;
            cursor: pointer;
        }
        .modal-value {
            font-size: 48px;
            margin: 10px 0;
            display: flex;
            justify-content: center;
            align-items: center;
        }
    </style>
</head>
<body>
    <div class="header">𝔑𝔗𝔘𝔐𝔈𝔇 ℭ𝔄𝔐𝔓</div>
    <button class="register-button" onclick="toggleRegister()">註冊</button>
    <button class="login-button" onclick="toggleLogin()">登入</button>
    <button id="orderButton" class="order-button" onclick="fetchOrders()" style="display:none;">委託</button>
    <button id="inventoryButton" class="inventory-button" onclick="fetchInventory()" style="display:none;">庫存</button>
    <button id="userButton" class="intro-button" style="display:none;"></button>

    <div id="orderModal" class="modal">
        <div class="modal-content">
            <button class="close-btn" onclick="toggleOrder()">&times;</button>
            <div id="order-container"></div>
        </div>
    </div>
    <div id="inventoryModal" class="modal">
        <div class="modal-content">
            <button class="close-btn" onclick="toggleInventory()">&times;</button>
            <div id="inventory-container"></div>
        </div>
    </div>

    <div id="registerModal" class="register-modal center">
        <button class="close-btn" onclick="toggleRegister()">×</button>
        <h2>註冊</h2>
        <div class="form-group">
            <label for="registerUsername">帳號：</label>
            <input type="text" id="registerUsername" placeholder="輸入帳號">
        </div>
        <div class="form-group">
            <label for="registerPassword">密碼：</label>
            <input type="password" id="registerPassword" placeholder="輸入密碼">
        </div>
        <div class="form-group">
            <button onclick="register()">註冊</button>
        </div>
    </div>
    <div id="loginModal" class="login-modal center">
        <button class="close-btn" onclick="toggleLogin()">×</button>
        <h2>登入</h2>
        <div class="form-group">
            <label for="loginUsername">帳號：</label>
            <input type="text" id="loginUsername" placeholder="輸入帳號">
        </div>
        <div class="form-group">
            <label for="loginPassword">密碼：</label>
            <input type="password" id="loginPassword" placeholder="輸入密碼">
        </div>
        <div class="form-group">
            <button onclick="login()">登入</button>
        </div>
    </div>
    <div class="areachart">
        <div id="chart-container" class="chart"></div>
        <script src="script.js"></script>
        </div>
    </div>
    <div class="container">
        <div class="button-row">
            <div class="toggle-button" id="toggle-button">
                <button onclick="toggleSlide('left')">整張</button>
                <button onclick="toggleSlide('right')">零股</button>
                <div class="slider stock-slider" id="slider" style="left: 2%;"></div>
            </div>
            <button class="button-leverage" id="leverage-button">1.00×</button>
        </div>
        <div class="toggle-button" id="margin-toggle">
            <button onclick="toggleMargin('left')">現股</button>
            <button onclick="toggleMargin('middle')">融資</button>
            <button onclick="toggleMargin('right')">融券</button>
            <div class="slider margin-slider" id="margin-slider"></div>
        </div>
        <div class="price-container">
            <div class="price-control">
                <button onclick="adjustPrice(-1)">－</button>
                <input type="number" id="price-input" value="0.00">
                <button onclick="adjustPrice(1)">＋</button>
            </div>
            <div class="quantity-control">
                <button onclick="adjustQuantity(-1)">－</button>
                <input type="number" id="quantity-input" value="1">
                <span id="unit-label">張</span>
                <button onclick="adjustQuantity(1)">＋</button>
            </div>
        </div>
        <div class="info">
            <span>預估金額</span>
            <span id="estimated-amount">等待更新中⋯</span>
        </div>
        <div class="info">
            <span>可用</span>
            <span id="balance">請先註冊或登入</span>
        </div>
        <button class="button button-buy">買入（做多）</button>
        <button class="button button-sell">賣出（做空）</button>
    </div>

    <!-- 模態視窗 -->
    <div class="modal" id="leverage-modal">
        <div class="modal-leverage">
            <span class="close" id="modal-close">&times;</span>
            <div class="current" id="modal-current">當前 1.00×</div>
            <div class="modal-value">
                <button class="control-btn" id="modal-decrement">-</button>
                <span id="modal-value">1.00×</span>
                <button class="control-btn" id="modal-increment">+</button>
            </div>
            <div class="multipliers" id="modal-multipliers">
                <div class="multiplier selected">1×</div>
                <div class="multiplier">2×</div>
                <div class="multiplier">3×</div>
                <div class="multiplier">5×</div>
                <div class="multiplier">10×</div>
                <div class="multiplier">20×</div>
                <div class="multiplier">50×</div>
                <div class="multiplier">75×</div>
                <div class="multiplier">100×</div>
            </div>
            <button class="confirm-btn" id="modal-confirm">確認</button>
        </div>
    </div>

    <script>
        const scriptUrl = 'https://script.google.com/macros/s/AKfycbxPoiqIEsIRR4rnsrjKzULK3Pm7GevufMIlqQ2rsuORIFBNx7KK_gAWIWELIUL3QolK/exec'; // 替換為你的Google Apps Script部署URL
        const placeOrderurl = 'https://script.google.com/macros/s/AKfycbyhzksDBRMkxyHNgjwZo-XLn_XJOIoVh4PGM1hBYOxc0Sq0g0Y0MmfJFGk69UrOkXA/exec'
        const leverageButton = document.getElementById('leverage-button');
        const leverageModal = document.getElementById('leverage-modal');
        const modalClose = document.getElementById('modal-close');
        const modalConfirm = document.getElementById('modal-confirm');
        const modalValueElement = document.getElementById('modal-value');
        const modalCurrentElement = document.getElementById('modal-current');
        const modalMultipliersElement = document.getElementById('modal-multipliers');
        const modalDecrementButton = document.getElementById('modal-decrement');
        const modalIncrementButton = document.getElementById('modal-increment');
        let currentValue = 1.00;
        let selectedValue = 1.00;
        let user = '';
        let latestPrice = null; // 新增變數來儲存最新的價格
        let orderType = '現股'; // 預設值

        function toggleRegister() {
            const registerModal = document.getElementById('registerModal');
            const loginModal = document.getElementById('loginModal'); // 新增這一行

            if (registerModal.style.display === 'none' || registerModal.style.display === '') {
                registerModal.style.display = 'block';
                registerModal.style.animation = 'fadeInZoom 0.5s forwards';
                loginModal.style.display = 'none'; // 新增這一行
            } else {
                registerModal.style.animation = 'fadeOutZoom 0.5s forwards';
                setTimeout(() => {
                    registerModal.style.display = 'none';
                }, 500);
            }
        }

        function toggleLogin() {
            const loginModal = document.getElementById('loginModal');
            const registerModal = document.getElementById('registerModal');

            if (loginModal.style.display === 'none' || loginModal.style.display === '') {
                loginModal.style.display = 'block';
                loginModal.style.animation = 'fadeInZoom 0.5s forwards';
                registerModal.style.display = 'none';
            } else {
                loginModal.style.animation = 'fadeOutZoom 0.5s forwards';
                setTimeout(() => {
                    loginModal.style.display = 'none';
                }, 500);
            }
        }

        function register() {
            const registerUsername = document.getElementById('registerUsername').value;
            const registerPassword = document.getElementById('registerPassword').value;
            fetch(`${scriptUrl}?action=registerUser&username=${registerUsername}&password=${registerPassword}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showMessage('註冊成功！', 'cashout-info');
                        username = registerUsername;  // 這裡賦值
                        user = registerUsername;
                        const userButton = document.getElementById('userButton');
                        userButton.style.display = 'block';
                        userButton.textContent = `${username}`;
                        document.querySelector('.login-button').style.display = 'none';
                        document.querySelector('.register-button').style.display = 'none';
                        document.getElementById('orderButton').style.display = 'block';
                        document.getElementById('inventoryButton').style.display = 'block';
                        balance = data.balance;
                        updateBalance();
                        toggleRegister();
                    } else {
                        showMessage(data.message, 'alert-info');
                    }
                });
        }

        function login() {
            const loginUsername = document.getElementById('loginUsername').value;
            const loginPassword = document.getElementById('loginPassword').value;
            fetch(`${scriptUrl}?action=checkLogin&username=${loginUsername}&password=${loginPassword}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        balance = data.balance;
                        user = loginUsername;
                        username = loginUsername;  // 這裡賦值
                        const userButton = document.getElementById('userButton');
                        userButton.style.display = 'block';
                        userButton.textContent = `${username}`;
                        document.querySelector('.login-button').style.display = 'none';
                        document.querySelector('.register-button').style.display = 'none';
                        document.getElementById('orderButton').style.display = 'block';
                        document.getElementById('inventoryButton').style.display = 'block';
                        updateBalance();
                        showMessage('登入成功！', 'cashout-info');
                        toggleLogin();
                    } else {
                        showMessage('登入失敗！', 'alert-info');
                    }
                });
        }

        

        function toggleOrder() {
            var modal = document.getElementById('orderModal');
            if (modal.style.display === "none" || modal.style.display === "") {
                modal.style.display = "flex";
                setTimeout(() => {
                    modal.style.animation = "fadeIn 0.5s forwards";
                }, 10);
            } else {
                modal.style.animation = "fadeOut 0.5s forwards";
                setTimeout(() => {
                    modal.style.display = "none";
                }, 500);
            }
        }
        function toggleInventory() {
            var modal = document.getElementById('inventoryModal');
            if (modal.style.display === "none" || modal.style.display === "") {
                modal.style.display = "flex";
                setTimeout(() => {
                    modal.style.animation = "fadeIn 0.5s forwards";
                }, 10);
            } else {
                modal.style.animation = "fadeOut 0.5s forwards";
                setTimeout(() => {
                    modal.style.display = "none";
                }, 500);
            }
        }

        function fetchInventory() {
            var url = `${placeOrderurl}?action=queryInventory&user=${user}`;
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    var container = document.getElementById('inventory-container');
                    container.innerHTML = '';
                    if (data.length === 0) {
                        container.innerHTML = '<p>暫無庫存</p>';
                    } else {
                        data.forEach(stock => {
                            var quantity = stock[2];
                            var avgPrice = (stock[3]).toFixed(2);
                            let margin;
                            var leveragePattern = /融資(\d+(\.\d+)?)×/;
                            var match = leveragePattern.exec(stock[4]);
                            
                            if (match) {
                                margin =  parseFloat(match[1]);
                            } else {
                                margin =  1;
                            }

                            if (stock[0] === 'NMedStock') {
                                stockName = '台大醫學概念股'
                            }
                            let profitPercent = ((latestPrice / avgPrice - 1) * 100).toFixed(2);
                            
                            if (stock[4] == '融券') {
                                profitPercent = -((latestPrice / avgPrice - 1) * 100).toFixed(2);
                            }


                            profitValue = Math.round((latestPrice - stock[3]) * quantity);

                            var profitClass = profitValue >= 0 ? 'profit' : 'loss';
                            var profitColor = profitValue >= 0 ? 'red' : 'green';



                            var stockHtml = `
                                <div class="stock-info">
                                    <div class="stock-number">
                                        <span class="current-stock">${stock[4]}</span>
                                        <span class="stock-name">${stock[0]}</span>
                                    </div>
                                    <h2>${stockName}</h2>
                                    <div class="info-row">
                                        <span class="info-label">總股數</span>
                                        <span class="info-value">${quantity}</span>
                                    </div>
                                    <div class="info-row">
                                        <span class="info-label">成交均價</span>
                                        <span class="info-value">${avgPrice}</span>
                                    </div>
                                    <div class="info-row">
                                        <span class="info-label">總損益</span>
                                        <span class="${profitClass}" style="color: ${profitColor};">${profitValue}（${profitPercent}%）</span>
                                    </div>
                                </div>`;
                            container.innerHTML += stockHtml;
                        });
                    }
                    toggleInventory();
                });
        }


        function fetchOrders() {
            var url = `${placeOrderurl}?action=queryOrders&user=${user}`;
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    var container = document.getElementById('order-container');
                    container.innerHTML = '';
                    if (data.length === 0) {
                        container.innerHTML = '<p>暫無委託</p>';
                    } else {
                        data.forEach(stock => {
                            if (stock[1] === 'NMedStock') {
                                stockName = '台大醫學概念股'
                            }
                            var quantity = stock[3];
                            var price = stock[4];
                            var status = stock[5];
                            var stockHtml = `
                                <div class="stock-info">
                                    <div class="stock-number">
                                        <span class="current-stock">${stock[6]}</span>
                                        <span class="stock-name">${stock[1]}</span>
                                    </div>
                                    <h2>${stockName}</h2>
                                    <div class="info-row">
                                        <span class="info-label">委託股數</span>
                                        <span class="info-value">${quantity}</span>
                                    </div>
                                    <div class="info-row">
                                        <span class="info-label">委託價格</span>
                                        <span class="info-value">${price}</span>
                                    </div>
                                    <div class="info-row">
                                        <span class="info-label">委託狀態</span>
                                        <span class="info-value">${status}</span>
                                    </div>
                                </div>`;
                            container.innerHTML += stockHtml;
                        });
                    }
                    toggleOrder();
                });
        }


        function showMessage(messageText, className) {
            const existingMessage = document.querySelector('.message');
            if (existingMessage) {
                document.body.removeChild(existingMessage);
            }
            const message = document.createElement('div');
            message.className = `message ${className}`;
            message.textContent = messageText;
            document.body.appendChild(message);

            setTimeout(() => {
                message.style.opacity = '0';
                setTimeout(() => {
                    document.body.removeChild(message);
                }, 1000); // 1秒後移除元素
            }, 1000); // 1秒後開始淡出
        }

        function updateBalance() {
            if (username) { // 如果用戶已登入
                balance = Math.round(balance * 100) / 100;
                document.getElementById('balance').textContent = Math.round(balance);
                updateServerBalance();
            } else {
                document.getElementById('balance').textContent = '請先註冊或登入';
            }
        }

        document.querySelector('.button-buy').addEventListener('click', function() {
            placeOrder('buy');
        });

        document.querySelector('.button-sell').addEventListener('click', function() {
            placeOrder('sell');
        });

        function placeOrder(type) {
            if (!user) {
                showMessage('請先登入', 'alert-info');
                return;
            }

            const price = parseFloat(document.getElementById('price-input').value);
            let quantity = parseInt(document.getElementById('quantity-input').value);
            const unit = document.getElementById('unit-label').innerText;
            if (unit === '張') {
                quantity *= 1000;
            }
            if (type === 'sell') {
                quantity = -quantity;
            }

            const symbol = 'NMedStock';
            const estimatedAmount = parseFloat(document.getElementById('estimated-amount').innerText.replace(/,/g, ''));

            if (type === 'buy' && estimatedAmount > balance) {
                showMessage('餘額不足', 'alert-info');
                return;
            }

            fetch(`${placeOrderurl}?action=placeOrder&user=${user}&symbol=${symbol}&quantity=${quantity}&price=${price}&orderType=${orderType}`)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'Order placed successfully') {
                        showMessage('訂單提交成功！', 'cashout-info');
                    } else {
                        showMessage('訂單提交失敗！', 'alert-info');
                    }
                });
        }


        function updateServerBalance() {
            fetch(`${scriptUrl}?action=updateBalance&username=${username}&balance=${balance}`)
                .then(response => response.json())
                .then(data => {
                    if (!data.success) {
                        showMessage('更新餘額失敗', 'alert-info');
                    }
                });
        }

        leverageButton.addEventListener('click', () => {
            leverageModal.style.display = 'flex';
            setTimeout(() => {
                leverageModal.classList.add('show');
            }, 10); // 微小的延遲，讓瀏覽器有時間應用 display 屬性
            currentValue = selectedValue;
            modalValueElement.textContent = `${currentValue.toFixed(2)}×`;
            modalCurrentElement.textContent = `當前 ${selectedValue.toFixed(2)}×`;

            // 確保選中的倍率有正確的CSS class
            const selectedElement = document.querySelector('.selected');
            if (selectedElement) {
                selectedElement.classList.remove('selected');
            }
            Array.from(modalMultipliersElement.children).forEach(multiplier => {
                if (parseFloat(multiplier.textContent) === currentValue) {
                    multiplier.classList.add('selected');
                    multiplier.scrollIntoView({ behavior: 'smooth', inline: 'center' });
                }
            });
        });


        modalClose.addEventListener('click', () => {
            leverageModal.classList.remove('show');
            setTimeout(() => {
                leverageModal.style.display = 'none';
            }, 300); // 與 CSS transition 時間一致，確保淡出完成後隱藏視窗
        });

        modalConfirm.addEventListener('click', () => {
            selectedValue = currentValue;
            leverageButton.textContent = `${selectedValue.toFixed(2)}×`;
            leverageModal.classList.remove('show');
            setTimeout(() => {
                leverageModal.style.display = 'none';
            }, 300); // 與 CSS transition 時間一致，確保淡出完成後隱藏視窗
        });

        modalConfirm.addEventListener('click', () => {
            selectedValue = currentValue;
            leverageButton.textContent = `${selectedValue.toFixed(2)}×`;
            leverageModal.classList.remove('show');
        });

        function updateModalValue(newValue) {
            currentValue = newValue;
            modalValueElement.textContent = `${newValue.toFixed(2)}×`;
            const selectedElement = document.querySelector('.selected');
            if (selectedElement) {
                selectedElement.classList.remove('selected');
            }
            Array.from(modalMultipliersElement.children).forEach(multiplier => {
                if (parseFloat(multiplier.textContent) === newValue) {
                    multiplier.classList.add('selected');
                    multiplier.scrollIntoView({ behavior: 'smooth', inline: 'center' });
                }
            });
        }


        modalDecrementButton.addEventListener('click', () => {
            if (currentValue > 1) updateModalValue(currentValue - 1);
        });

        modalIncrementButton.addEventListener('click', () => {
            if (currentValue < 100) updateModalValue(currentValue + 1);
        });

        Array.from(modalMultipliersElement.children).forEach(multiplier => {
            multiplier.addEventListener('click', () => {
                const newValue = parseFloat(multiplier.textContent);
                updateModalValue(newValue);
            });
        });

        function toggleSlide(direction) {
            var slider = document.getElementById('slider');
            var unitLabel = document.getElementById('unit-label');
            if (direction === 'left') {
                slider.style.left = '2%';
                unitLabel.innerText = '張';
            } else {
                slider.style.left = '52%';
                unitLabel.innerText = '股';
            }
            updateEstimatedAmount();
        }

        function toggleMargin(direction) {
            var slider = document.getElementById('margin-slider');
            if (direction === 'left') {
                slider.style.left = '1%';
                orderType = '現股';
            } else if (direction === 'middle') {
                slider.style.left = '34.3333333333%';
                orderType = `融資${currentValue}×`; // 使用模板字串插入 currentValue
            } else {
                slider.style.left = '67.6666666666%';
                orderType = '融券';
            }
        }

        function adjustPrice(direction) {
            var priceInput = document.getElementById('price-input');
            var price = parseFloat(priceInput.value);
            if (price < 10) {
                price += direction * 0.01;
            } else if (price < 50) {
                price += direction * 0.05;
            } else if (price < 100) {
                price += direction * 0.1;
            } else if (price < 500) {
                price += direction * 0.5;
            } else if (price < 1000) {
                price += direction * 1;
            } else {
                price += direction * 5;
            }
            if (price < 0) price = 0;
            priceInput.value = price.toFixed(2);
            updateEstimatedAmount();
        }

        function adjustQuantity(direction) {
            var quantityInput = document.getElementById('quantity-input');
            var quantity = parseInt(quantityInput.value);
            quantity += direction;
            if (quantity <= 0) quantity = 1;
            quantityInput.value = quantity;
            updateEstimatedAmount();
        }

        function updateEstimatedAmount() {
            var price = parseFloat(document.getElementById('price-input').value);
            var quantity = parseInt(document.getElementById('quantity-input').value);
            var unit = document.getElementById('unit-label').innerText;
            var estimatedAmount = price * quantity;
            if (unit === '張') {
                estimatedAmount *= 1000;
            }
            document.getElementById('estimated-amount').innerText = numberWithCommas(trimTrailingZeros(estimatedAmount.toFixed(2)));
        }

        function trimTrailingZeros(numStr) {
            return numStr.replace(/(\.\d*[1-9])0+$/, "$1").replace(/\.0+$/, "");
        }

        function numberWithCommas(x) {
            return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }

        document.getElementById('price-input').addEventListener('input', function() {
            var priceInput = document.getElementById('price-input');
            var price = parseFloat(priceInput.value);
            if (isNaN(price) || price < 0) {
                priceInput.value = 0;
            } else {
                priceInput.value = price.toFixed(2);
            }
            updateEstimatedAmount();
        });

        document.getElementById('quantity-input').addEventListener('input', function() {
            var quantityInput = document.getElementById('quantity-input');
            var quantity = parseInt(quantityInput.value);

            if (isNaN(quantity) || quantity < 1) {
                quantityInput.value = 1;
            }
            updateEstimatedAmount();
        });
    </script>
</body>
</html>
