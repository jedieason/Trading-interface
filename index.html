<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>交易界面</title>
    <script src="highstock.js"></script>
    <script src="exporting.js"></script>
    <script src="export-data.js"></script>
    <script src="accessibility.js"></script>
    <style>
        @keyframes fadeIn {
            0% {
                opacity: 0;
            }
            100% {
                opacity: 0.9;
            }
        }

        @keyframes fadeOut {
            0% {
                opacity: 0.9;
            }
            100% {
                opacity: 0;
            }
        }

        /* 保留原有的 fadeInZoom 和 fadeOutZoom 動畫規則 */
        @keyframes fadeInZoom {
            0% {
                opacity: 0;
                transform: scale(0.8);
            }
            100% {
                opacity: 0.9;
                transform: scale(1);
            }
        }

        @keyframes fadeOutZoom {
            0% {
                opacity: 0.9;
                transform: scale(1);
            }
            100% {
                opacity: 0;
                transform: scale(0.8);
            }
        }


        

        .header {
            position: absolute;
            top: 20px;
            left: 22px;
            font-size: 1.4em;
            color: #333;
        }
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #ffffff;
            color: #333;
            margin: 0;
            position: relative;
            height: 100%; /* 調整高度 */
            width: 100%; /* 調整寬度 */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .constum-body {
            font-family: 'Roboto', sans-serif;
            background-color: #f4f4f9;
            color: #333;
            margin: 0;
            position: relative;
            height: 100%; /* 調整高度 */
            width: 100%; /* 調整寬度 */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        
        .container {
            width: 95%;
            margin: 0 auto;
            text-align: center;
            position: relative;
            z-index: 0; /* 確保內容在背景 */
            padding-top: 0px; /* 增加填充確保內容不遮擋標題和按鈕 */
        }

        .areachart {
            width: 95%;
            margin: 0 auto;
            text-align: center;
            position: relative;
            z-index: 0; /* 確保內容在背景 */
            padding-top: 40px; /* 增加填充確保內容不遮擋標題和按鈕 */
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 1em;
            color: #333;
        }

        .form-group input {
            width: 100%;
            padding: 10px;
            font-size: 1em;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
            outline: none;
        }

        .form-group button {
            width: 100%;
            padding: 10px;
            font-size: 1em;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            background-color: #000;
            color: #fff;
            transition: box-shadow 0.2s ease;
            outline: none;
        }
        .message {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 10px;
            border-radius: 15px;
            color: #fff;
            opacity: 1;
            transition: opacity 1s ease-out;
        }

        .header-button-row {
            display: flex;
            position: absolute;
            top: 23px;
            right: 20px;
            align-items: center;
            z-index: 1000;
        }

        .intro-button,
        .register-button,
        .login-button,
        .inventory-button,
        .order-button {
            font-size: 1em;
            cursor: pointer;
            background: none;
            border: none;
            outline: none;
            padding: 3px 6px;
        }

        .login-button {
            color: #fff;
            background: #000;
            border-radius: 6px;
            padding: 3px 6px;
        }

        .intro-button,
        .register-button,
        .inventory-button,
        .order-button {
            color: #aaa;
        }

        .divider {
            border-left: 1px solid #ddd; /* 顏色和簡介按鈕一致 */
            height: 14px; /* 調整高度以適應按鈕 */
        }


        .register-modal,
        .login-modal {
            position: fixed;
            top: 27%;
            transform: translate(-50%, -50%);
            background: #fff;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            width: 80%;
            text-align: left;
            animation: fadeInZoom 0.5s forwards;
            z-index: 10;
            display: none;
            z-index: 2000; /* 增加這行 */
        }

        .cashout-info,
        .alert-info {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.5);
            padding: 5px 10px;
            border-radius: 15px;
            color: #fff;
            opacity: 1;
            transition: opacity 1s ease-out;
        }

        .alert-info {
            background: rgba(255, 0, 0, 0.7);
        }

        #loadingMessage {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(255, 255, 255, 0.8);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 3000;
        }
        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: black;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .message-text {
            font-size: 18px;
            font-weight: 500;
            color: black;
        }


        .close-btn {
            background: none;
            border: none;
            font-size: 1.2em;
            cursor: pointer;
            color: #000;
            position: absolute;
            top: 10px;
            right: 10px;
        }

        .button {
            background-color: #f0f0f0;
            border: none;
            padding: 10px 20px;
            margin: 5px 0;
            cursor: pointer;
            border-radius: 5px;
            display: block;
            width: 100%;
            box-sizing: border-box;
            color: black;
            font-size: 16px;
        }

        .balance {
            margin-left: auto; /* 右對齊 */
            font-size: 16px;
        }


        .button-leverage {
            background-color: #f0f0f0;
            border: none;
            margin: 5px 0;
            cursor: pointer;
            border-radius: 5px;
            display: block;
            width: 25%;
            box-sizing: border-box;
            color: black;
            font-size: 16px;
        }

        .button-row {
            display: flex;
            justify-content: space-between;
        }

        .button-row .button {
            width: 48%;
        }


        .toggle-button {
            display: flex;
            position: relative;
            margin: 5px 0;
            height: 40px;
            background-color: #f0f0f0;
            border-radius: 5px;
        }
        .toggle-button button {
            width: 50%;
            z-index: 1;
            position: relative;
            background-color: transparent;
            border: none;
            padding: 10px 25px;
            cursor: pointer;
            font-size: 16px;
            color: black;
        }
        .stock-info {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            max-width: 100%;
        }
        .stock-number {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }
        .current-stock {
            background-color: #000000;
            color: white;
            padding: 3px 6px;
            border-radius: 15px;
            font-size: 14px;
            margin-right: 10px;
        }
        .stock-name {
            font-size: 16px;
            color: #666;
        }
        .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        .info-label {
            color: #666;
        }
        .info-value {
            font-weight: bold;
        }
        .profit {
            font-weight: bold;
        }
        
        .slider {
            position: absolute;
            top: 5%;
            height: 90%;
            background-color: #fff;
            border-radius: 5px;
            transition: 0.4s;
        }
        .margin-slider {
            width: 31.33333333333%;
            left: 1%;
        }
        .toggle-button.active .margin-slider {
            left: 50%;
        }
        .stock-slider {
            width: 46%;
            left: 2%;
        }
        .toggle-button.active .stock-slider {
            left: 50%;
        }
        .button-buy {
            background-color: #4caf50;
            color: white;
        }
        .button-sell {
            background-color: #f44336;
            color: white;
        }
        .price-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 10px 0;
        }
        .price-control, .quantity-control {
            display: flex;
            align-items: center;
            border: 1px solid #ccc;
            border-radius: 5px;
            overflow: hidden;
            width: 48%;
        }
        .price-control button, .quantity-control button {
            background-color: #fff;
            border: none;
            padding: 5px;
            font-size: 25px;
            cursor: pointer;
            color: black;
            width: 20%;
        }
        .price-control input, .quantity-control input {
            text-align: center;
            border: none;
            font-size: 20px;
            background-color: #fff;
            margin: 0;
            padding: 10px 0;
            width: 60%;
        }
        .quantity-control span {
            font-size: 12px;
            color: #999;
        }
        .info {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            font-size: 16px;
            width: 100%; /* 確保整行佔滿寬度 */
        }
        .chart {
            height: 400px;
            margin: 20px 0 0 0;
            font-size: 16px;
        }
        /* 視窗樣式 */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            align-items: center;
            justify-content: center;
            z-index: 2;
            opacity: 0;
            z-index: 2000; /* 增加這行 */
            transition: opacity 0.3s; /* 將 transition 時間設置為 0.3s */
        }
        .modal.show {
            display: flex;
            opacity: 1;
        }
        .modal-leverage {
            background-color: white;
            border-radius: 15px;
            width: 85%;
            padding: 20px;
            text-align: center;
            position: relative;
        }
        .modal-content {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            max-width: 500px;
            width: 80%;
            max-height: 80%; /* 限制視窗高度 */
            overflow-y: auto; /* 內容可滾動 */
            position: relative;
            animation: fadeInZoom 0.5s forwards;
        }
        .close {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 24px;
            cursor: pointer;
            color: black;
        }
        .control-btn {
            font-size: 24px;
            padding: 5px 15px;
            margin: 0 10px;
            border: none;
            background-color: #f0f0f0;
            cursor: pointer;
            color: black;
            border-radius: 5px;
        }
        .multipliers {
            display: flex;
            overflow-x: scroll;
            margin: 20px 0;
            scrollbar-width: none; /* Firefox */
        }
        .multipliers::-webkit-scrollbar {
            display: none; /* Safari and Chrome */
        }
        .multiplier {
            padding: 10px;
            margin: 0 5px;
            cursor: pointer;
            white-space: nowrap;
            transition: background-color 0.3s, color 0.3s;
            border-radius: 10px; /* 保持圓角 */
        }
        .selected {
            background-color: black;
            color: white;
        }
        .confirm-btn {
            font-size: 18px;
            color: white;
            background-color: black;
            border: none;
            padding: 10px 60px;
            border-radius: 20px;
            cursor: pointer;
        }
        .modal-value {
            font-size: 48px;
            margin: 10px 0;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .success-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 4px solid #4CAF50;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 15px;
            position: relative;
        }
        .success-icon::before,
        .success-icon::after {
            content: '';
            position: absolute;
            background-color: #4CAF50;
        }
        .success-icon::before {
            width: 4px;
            height: 20px;
            transform: rotate(45deg);
            top: 16px;
            left: 26.5px;
        }
        .success-icon::after {
            width: 4px;
            height: 10px;
            transform: rotate(-45deg);
            top: 24px;
            left: 18px;
        }

        .selection-header {
            display: flex;
            justify-content: space-between;
            border-bottom: 1px solid #e0e0e0;
            padding-bottom: 10px;
            margin-top: 8px;
            margin-bottom: 10px;
            font-weight: bold;
        }
        .selection-button {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            padding: 10px 0;
            border: none;
            background: none;
            text-align: left;
            cursor: pointer;
            font-size: 16px;
        }
        .selection-name {
            flex: 1;
            color: black;
        }
        .selection-code {
            font-size: 0.8em;
            color: #aaa;
        }
        .selection-price {
            flex: 1;
            text-align: center;
        }
        .selection-change {
            flex: 1;
            text-align: right;
        }
        .positive {
            color: red;
        }
        .negative {
            color: green;
        }
        .neutral {
            color: black;
        }
        .Selection-button {
            background-color: #f0f0f0;
            border: none;
            margin: 5px 0;
            cursor: pointer;
            border-radius: 5px;
            display: block;
            width: 23%;
            box-sizing: border-box;
            color: black;
            font-size: 16px;
        }
        .Selection-modal {
            position: fixed;
            top: 25%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.97);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            width: 80%;
            text-align: left;
            animation: fadeInZoom 0.5s forwards;
            z-index: 10;
            display: none;
        }

        .Selection-modal {
            top: 27%;
        }
    </style>
</head>
<body>
    <div class="header">𝔑𝔗𝔘𝔐𝔈𝔇 ℭ𝔄𝔐𝔓</div>
    <div class="header-button-row">
        <button id="orderButton" class="order-button" onclick="fetchOrders()" style="display:none;">委託</button>
        <div id="divider" class="divider"  style="display:none;"></div>
        <button id="inventoryButton" class="inventory-button" onclick="fetchInventory()" style="display:none;">庫存</button>
        <div id="divider" class="divider"  style="display:none;"></div>
        <button class="register-button" onclick="toggleRegister()">註冊</button>
        <button class="login-button" onclick="toggleLogin()">登入</button>
        <button id="userButton" class="intro-button" style="display:none;"></button>
    </div>
    
    <div id="orderModal" class="modal">
        <div class="modal-content">
            <button class="close-btn" onclick="toggleOrder()">&times;</button>
            <div id="order-container"></div>
        </div>
    </div>
    <div id="inventoryModal" class="modal">
        <div class="modal-content">
            <button class="close-btn" onclick="toggleInventory()">&times;</button>
            <div id="inventory-container"></div>
        </div>
    </div>
    <div id="SelectionModal" class="Selection-modal center">
        <button class="close-btn" onclick="toggleSelection()">×</button>
        <div class="selection-header">
            <span class="selection-name">股名</span>
            <span class="selection-price">成交價</span>
            <span class="selection-change">小時漲跌幅</span>
        </div>
        <button class="selection-button" onclick="Selection(event)" data-index="1">
            <span class="selection-name">Close AI<br><span class="selection-code">5268.TW</span></span>
            <span class="selection-price" id="stock1-price">0.00</span>
            <span class="selection-change" id="stock1-change">0.00%</span>
        </button>
        <button class="selection-button" onclick="Selection(event)" data-index="2">
            <span class="selection-name">台積雷<br><span class="selection-code">2331.TW</span></span>
            <span class="selection-price" id="stock2-price">0.00</span>
            <span class="selection-change" id="stock2-change">0.00%</span>
        </button>
        <button class="selection-button" onclick="Selection(event)" data-index="3">
            <span class="selection-name">Macrosoft<br><span class="selection-code">1975.TW</span></span>
            <span class="selection-price" id="stock3-price">0.00</span>
            <span class="selection-change" id="stock3-change">0.00%</span>
        </button>
        <button class="selection-button" onclick="Selection(event)" data-index="4">
            <span class="selection-name">黃達<br><span class="selection-code">2383.TW</span></span>
            <span class="selection-price" id="stock4-price">0.00</span>
            <span class="selection-change" id="stock4-change">0.00%</span>
        </button>
        <button class="selection-button" onclick="Selection(event)" data-index="5">
            <span class="selection-name">迪土尼<br><span class="selection-code">1923.TW</span></span>
            <span class="selection-price" id="stock5-price">0.00</span>
            <span class="selection-change" id="stock5-change">0.00%</span>
        </button>
    </div>

    <div id="registerModal" class="register-modal center">
        <button class="close-btn" onclick="toggleRegister()">×</button>
        <h2>註冊</h2>
        <div class="form-group">
            <label for="registerUsername">帳號：</label>
            <input type="text" id="registerUsername" placeholder="輸入帳號">
        </div>
        <div class="form-group">
            <label for="registerPassword">密碼：</label>
            <input type="password" id="registerPassword" placeholder="輸入密碼">
        </div>
        <div class="form-group">
            <button onclick="register()">註冊</button>
        </div>
    </div>
    <div id="loginModal" class="login-modal center">
        <button class="close-btn" onclick="toggleLogin()">×</button>
        <h2>登入</h2>
        <div class="form-group">
            <label for="loginUsername">帳號：</label>
            <input type="text" id="loginUsername" placeholder="輸入帳號">
        </div>
        <div class="form-group">
            <label for="loginPassword">密碼：</label>
            <input type="password" id="loginPassword" placeholder="輸入密碼">
        </div>
        <div class="form-group">
            <button onclick="login()">登入</button>
        </div>
    </div>
    <div class="areachart">
        <div id="chart-container" class="chart"></div>
        <script src="script.js"></script>
        </div>
    </div>
    <div class="container">
        <div class="button-row">
            <div class="toggle-button" id="toggle-button">
                <button onclick="toggleSlide('left')">整張</button>
                <button onclick="toggleSlide('right')">零股</button>
                <div class="slider stock-slider" id="slider" style="left: 2%;"></div>
            </div>
            <!-- 修改選股按鈕 -->
            <button class="Selection-button" onclick="toggleSelection(); updateAllStockData();">選股</button>
            <button class="button-leverage" id="leverage-button">1.00x</button>
        </div>
        <div class="toggle-button" id="margin-toggle">
            <button onclick="toggleMargin('left')">現股</button>
            <button onclick="toggleMargin('middle')">融資</button>
            <button onclick="toggleMargin('right')">融券</button>
            <div class="slider margin-slider" id="margin-slider"></div>
        </div>
        <div class="price-container">
            <div class="price-control">
                <button onclick="adjustPrice(-1)">－</button>
                <input type="number" id="price-input" value="0.00">
                <button onclick="adjustPrice(1)">＋</button>
            </div>
            <div class="quantity-control">
                <button onclick="adjustQuantity(-1)">－</button>
                <input type="number" id="quantity-input" value="1">
                <span id="unit-label">張</span>
                <button onclick="adjustQuantity(1)">＋</button>
            </div>
        </div>
        <div class="info">
            <span>預估金額</span>
            <span id="estimated-amount">等待更新中⋯</span>
        </div>
        <div class="info">
            <span>可用</span>
            <span id="balance">請先註冊或登入</span>
        </div>
        <button class="button button-buy">買入（做多）</button>
        <button class="button button-sell">賣出（做空）</button>
    </div>

    <!-- 加載動畫 -->
        <div id="loadingMessage">
            <div class="spinner"></div>
            <div class="message-text">修蛋幾勒</div>
        </div>


    <!-- 模態視窗 -->
    <div class="modal" id="leverage-modal">
        <div class="modal-leverage">
            <span class="close" id="modal-close">&times;</span>
            <div class="current" id="modal-current">當前 1.00x</div>
            <div class="modal-value">
                <button class="control-btn" id="modal-decrement">-</button>
                <span id="modal-value">1.00x</span>
                <button class="control-btn" id="modal-increment">+</button>
            </div>
            <div class="multipliers" id="modal-multipliers">
                <div class="multiplier selected">1x</div>
                <div class="multiplier">2x</div>
                <div class="multiplier">3x</div>
                <div class="multiplier">5x</div>
                <div class="multiplier">10x</div>
                <div class="multiplier">20x</div>
                <div class="multiplier">50x</div>
                <div class="multiplier">75x</div>
                <div class="multiplier">100x</div>
            </div>
            <button class="confirm-btn" id="modal-confirm">確認</button>
        </div>
    </div>
    <script>
        const scriptUrl = 'https://script.google.com/macros/s/AKfycbxPoiqIEsIRR4rnsrjKzULK3Pm7GevufMIlqQ2rsuORIFBNx7KK_gAWIWELIUL3QolK/exec'; // 替換為你的Google Apps Script部署URL
        const placeOrderurl = 'https://script.google.com/macros/s/AKfycbwAL3LtHnKB3wWDPVBYu-NQ8J_RryyEPktysjaEy--tfxZryMo0cCYW1Rvlrg-_3kI/exec'
        const Stock1url = "https://script.google.com/macros/s/AKfycbxYnx52JChtOhzVSpLyaOXEV9HhXxCCAnZlJFHkPHJBIBldtsG1ZIgtNrAwxFb0zIk/exec";
        const Stock2url = "https://script.google.com/macros/s/AKfycbwIvDADxlxf076RuWa34BzmbJDa0_-0a_vTAofZS4GU8bCLaSCN6h0w_hz6a5RRuBFj/exec";
        const Stock3url = "https://script.google.com/macros/s/AKfycbxdqFsj6COZ0lFUafz_3bFi4D76ZQwfz5s_8-_-kxTLg_TbN5Mf7K-A7sSzqnDrFwGR/exec";
        const Stock4url = "https://script.google.com/macros/s/AKfycbxje-mLTTFn_5vl4B2oTpvg6uh1Q7VWQI1yeDIl8P6sY1pdk3S7RXAjCgDdjcOGe60/exec";
        const Stock5url = "https://script.google.com/macros/s/AKfycbzt0L8acGkTPzQkTApwASGJPvkUBmn_Kd3ryg6I4QL_fJuCRcD5S0Fc5U9BhKT7ZAc/exec";
        const leverageButton = document.getElementById('leverage-button');
        const leverageModal = document.getElementById('leverage-modal');
        const modalClose = document.getElementById('modal-close');
        const modalConfirm = document.getElementById('modal-confirm');
        const modalValueElement = document.getElementById('modal-value');
        const modalCurrentElement = document.getElementById('modal-current');
        const modalMultipliersElement = document.getElementById('modal-multipliers');
        const modalDecrementButton = document.getElementById('modal-decrement');
        const modalIncrementButton = document.getElementById('modal-increment');
        let sheetDataUrl = "https://script.google.com/macros/s/AKfycbxYnx52JChtOhzVSpLyaOXEV9HhXxCCAnZlJFHkPHJBIBldtsG1ZIgtNrAwxFb0zIk/exec";
        let currentValue = 1.00;
        let selectedValue = 1.00;
        let user = '';
        let latestPrice; // 新增變數來儲存最新的價格
        let orderType = '現股'; // 預設值
        let onMargin = false;
        let balance;
        let symbol = '5268.TW';
        let placingOrders = false;
        
        const loadingMessage = document.getElementById('loadingMessage');

        document.addEventListener("DOMContentLoaded", () => {
                        // 檢查 localStorage 中是否有儲存的使用者資訊
            const savedUsername = localStorage.getItem('username');
            const savedPassword = localStorage.getItem('password');

            if (savedUsername && savedPassword) {
                // 自動登入
                user = savedUsername;
                username = savedUsername;  // 這裡賦值
                // balance = await getBalance(username);
                updateBalance();
                const userButton = document.getElementById('userButton');
                const dividers = document.querySelectorAll('.divider');
                userButton.style.display = 'block';
                userButton.textContent = `${username}`;
                document.querySelector('.login-button').style.display = 'none';
                document.querySelector('.register-button').style.display = 'none';
                document.getElementById('orderButton').style.display = 'block';
                document.getElementById('inventoryButton').style.display = 'block';
                dividers.forEach(divider => {
                    divider.style.display = 'block';
                });
                showMessage('自動登入成功！', 'cashout-info');
            }
            updateAllStockData();
        });

        function updateAllStockData() {
            updateStockData(Stock1url, document.getElementById("stock1-price"), document.getElementById("stock1-change"));
            updateStockData(Stock2url, document.getElementById("stock2-price"), document.getElementById("stock2-change"));
            updateStockData(Stock3url, document.getElementById("stock3-price"), document.getElementById("stock3-change"));
            updateStockData(Stock4url, document.getElementById("stock4-price"), document.getElementById("stock4-change"));
            updateStockData(Stock5url, document.getElementById("stock5-price"), document.getElementById("stock5-change"));
        }


        function showLoading() {
            loadingMessage.innerHTML = `
                <div class="spinner"></div>
                <div class="message-text">修蛋幾勒</div>
            `;
            loadingMessage.style.display = 'flex';
            setTimeout(() => {
                loadingMessage.style.opacity = '1';
            }, 10);
        }

        function hideLoading() {
            loadingMessage.style.opacity = '0';
            setTimeout(() => {
                loadingMessage.style.display = 'none';
            }, 500);
        }
        
        function showSuccess() {
            loadingMessage.innerHTML = `
                <div class="success-icon"></div>
                <div class="message-text">委託成功</div>
            `;
            loadingMessage.style.display = 'flex';
            setTimeout(() => {
                loadingMessage.style.opacity = '1';
            }, 10);

            setTimeout(() => {
                loadingMessage.style.opacity = '0';
                setTimeout(() => {
                    loadingMessage.style.display = 'none';
                }, 1000); // 淡出動畫的持續時間
            }, 1000); // 1秒後開始淡出
        }


        function toggleRegister() {
            const registerModal = document.getElementById('registerModal');
            const loginModal = document.getElementById('loginModal'); // 新增這一行

            if (registerModal.style.display === 'none' || registerModal.style.display === '') {
                registerModal.style.display = 'block';
                registerModal.style.animation = 'fadeInZoom 0.5s forwards';
                loginModal.style.display = 'none'; // 新增這一行
            } else {
                registerModal.style.animation = 'fadeOutZoom 0.5s forwards';
                setTimeout(() => {
                    registerModal.style.display = 'none';
                }, 500);
            }
        }

        function toggleLogin() {
            const loginModal = document.getElementById('loginModal');
            const registerModal = document.getElementById('registerModal');

            if (loginModal.style.display === 'none' || loginModal.style.display === '') {
                loginModal.style.display = 'block';
                loginModal.style.animation = 'fadeInZoom 0.5s forwards';
                registerModal.style.display = 'none';
            } else {
                loginModal.style.animation = 'fadeOutZoom 0.5s forwards';
                setTimeout(() => {
                    loginModal.style.display = 'none';
                }, 500);
            }
        }

        function register() {
            const registerUsername = document.getElementById('registerUsername').value;
            const registerPassword = document.getElementById('registerPassword').value;
            showLoading();
            fetch(`${scriptUrl}?action=registerUser&username=${registerUsername}&password=${registerPassword}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        hideLoading();
                        showMessage('註冊成功！', 'cashout-info');
                        username = registerUsername;  // 這裡賦值
                        user = registerUsername;
                        localStorage.setItem('username', loginUsername);
                        localStorage.setItem('password', loginPassword);
                        const userButton = document.getElementById('userButton');
                        const dividers = document.querySelectorAll('.divider');
                        userButton.style.display = 'block';
                        userButton.textContent = `${username}`;
                        document.querySelector('.login-button').style.display = 'none';
                        document.querySelector('.register-button').style.display = 'none';
                        document.getElementById('orderButton').style.display = 'block';
                        document.getElementById('inventoryButton').style.display = 'block';
                        dividers.forEach(divider => {
                            divider.style.display = 'block';
                        });
                        balance = data.balance;
                        updateBalance();
                        toggleRegister();
                    } else {
                        hideLoading();
                        showMessage(data.message, 'alert-info');
                    }
                });
        }

        function login() {
            const loginUsername = document.getElementById('loginUsername').value;
            const loginPassword = document.getElementById('loginPassword').value;
            showLoading();
            fetch(`${scriptUrl}?action=checkLogin&username=${loginUsername}&password=${loginPassword}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        hideLoading();
                        balance = data.balance;
                        user = loginUsername;
                        username = loginUsername;  // 這裡賦值
                        localStorage.setItem('username', loginUsername);
                        localStorage.setItem('password', loginPassword);
                        const userButton = document.getElementById('userButton');
                        const dividers = document.querySelectorAll('.divider');
                        userButton.style.display = 'block';
                        userButton.textContent = `${username}`;
                        document.querySelector('.login-button').style.display = 'none';
                        document.querySelector('.register-button').style.display = 'none';
                        document.getElementById('orderButton').style.display = 'block';
                        document.getElementById('inventoryButton').style.display = 'block';
                        dividers.forEach(divider => {
                            divider.style.display = 'block';
                        });
                        updateBalance();
                        showMessage('登入成功！', 'cashout-info');
                        toggleLogin();
                    } else {
                        hideLoading();
                        showMessage('登入失敗！', 'alert-info');
                    }
                });
        }

        

        function toggleOrder() {
            var modal = document.getElementById('orderModal');
            if (modal.style.display === "none" || modal.style.display === "") {
                modal.style.display = "flex";
                setTimeout(() => {
                    modal.style.animation = "fadeIn 0.5s forwards";
                }, 10);
            } else {
                modal.style.animation = "fadeOut 0.5s forwards";
                setTimeout(() => {
                    modal.style.display = "none";
                }, 500);
            }
        }
        function toggleInventory() {
            var modal = document.getElementById('inventoryModal');
            if (modal.style.display === "none" || modal.style.display === "") {
                modal.style.display = "flex";
                setTimeout(() => {
                    modal.style.animation = "fadeIn 0.5s forwards";
                }, 10);
            } else {
                modal.style.animation = "fadeOut 0.5s forwards";
                setTimeout(() => {
                    modal.style.display = "none";
                }, 500);
            }
        }

        function fetchInventory() {
            showLoading();
            var url = `${placeOrderurl}?action=queryInventory&user=${user}`;
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    var container = document.getElementById('inventory-container');
                    container.innerHTML = '';
                    if (data.length === 0) {
                        hideLoading();
                        container.innerHTML = '<p>暫無庫存</p>';
                    } else {
                        hideLoading();
                        data.forEach(stock => {
                            let margin;
                            var quantity = stock[2];
                            var avgPrice = (stock[3]).toFixed(2);
                            var leveragePattern = /融資(\d+(\.\d+)?)×/;
                            var match = leveragePattern.exec(stock[4]);
                            if (match != null) {
                                margin = parseFloat(match[1]);
                            } else{
                                margin = 1;
                            }
                            let stockName = '';
                            if (stock[1] === '5268.TW') {
                                stockName = 'Close AI'
                            } else if (stock[1] === '2331.TW') {
                              stockName = '台積雷'
                            } else if (stock[1] === '1975.TW') {
                                stockName = 'Macrosoft'
                            } else if (stock[1] === '2383.TW') {
                                stockName = '黃達'
                            } else if (stock[1] === '1923.TW') {
                                stockName = '迪土尼'
                            } 

                            let profitPercent = ((latestPrice / avgPrice - 1) * margin * 100).toFixed(2);
                            
                            if (stock[4] == '融券') {
                                profitPercent = -((latestPrice / avgPrice - 1) * 100).toFixed(2);
                            }


                            profitValue = Math.round((latestPrice - stock[3]) * quantity);

                            var profitClass = profitValue >= 0 ? 'profit' : 'loss';
                            var profitColor = profitValue === 0 ? 'black' : (profitValue > 0 ? 'red' : 'green');
                            console.log(latestPrice);


                            var stockHtml = `
                                <div class="stock-info">
                                    <div class="stock-number">
                                        <span class="current-stock">${stock[4]}</span>
                                        <span class="stock-name">${stock[0]}</span>
                                    </div>
                                    <h2>${stockName}</h2>
                                    <div class="info-row">
                                        <span class="info-label">總股數</span>
                                        <span class="info-value">${quantity}</span>
                                    </div>
                                    <div class="info-row">
                                        <span class="info-label">成交均價</span>
                                        <span class="info-value">${avgPrice}</span>
                                    </div>
                                    <div class="info-row">
                                        <span class="info-label">總損益</span>
                                        <span class="${profitClass}" style="color: ${profitColor};">${profitValue}（${profitPercent}%）</span>
                                    </div>
                                </div>`;
                            container.innerHTML += stockHtml;
                        });
                    }
                    toggleInventory();
                });
        }

        function toggleSelection() {
             const SelectionModal = document.getElementById('SelectionModal');
             const registerModal = document.getElementById('registerModal');

             if (SelectionModal.style.display === 'none' || SelectionModal.style.display === '') {
                 SelectionModal.style.display = 'block';
                 SelectionModal.style.animation = 'fadeInZoom 0.5s forwards';
                 registerModal.style.display = 'none';
             } else {
                 SelectionModal.style.animation = 'fadeOutZoom 0.5s forwards';
                 setTimeout(() => {
                     SelectionModal.style.display = 'none';
                 }, 500);
             }
         }

        function Selection(event) {
            const button = event.currentTarget;
            symbol = button.querySelector('.selection-code').innerText;
            let NameofStock = button.querySelector('.selection-name').innerText;
            const index = button.getAttribute('data-index');
            let url;
            if (index == 1){
                url = "https://script.google.com/macros/s/AKfycbxYnx52JChtOhzVSpLyaOXEV9HhXxCCAnZlJFHkPHJBIBldtsG1ZIgtNrAwxFb0zIk/exec";
            } else if (index == 2){
                url = "https://script.google.com/macros/s/AKfycbwIvDADxlxf076RuWa34BzmbJDa0_-0a_vTAofZS4GU8bCLaSCN6h0w_hz6a5RRuBFj/exec";
            } else if (index == 3){
                url = "https://script.google.com/macros/s/AKfycbxdqFsj6COZ0lFUafz_3bFi4D76ZQwfz5s_8-_-kxTLg_TbN5Mf7K-A7sSzqnDrFwGR/exec";
            } else if (index == 4){
                url = "https://script.google.com/macros/s/AKfycbxje-mLTTFn_5vl4B2oTpvg6uh1Q7VWQI1yeDIl8P6sY1pdk3S7RXAjCgDdjcOGe60/exec";
            } else if (index == 5) {
                url = "https://script.google.com/macros/s/AKfycbzt0L8acGkTPzQkTApwASGJPvkUBmn_Kd3ryg6I4QL_fJuCRcD5S0Fc5U9BhKT7ZAc/exec";
            }

            // 移除名稱中的編號
            NameofStock = NameofStock.split('<br>')[0];

            // 使用 myModule 設置新的 sheetDataUrl 並初始化圖表
            myModule.then(module => {
                module.setSheetDataUrl(url);
                module.setNameofStock(NameofStock); // 設置新的名稱
                module.initializeChart();
            });

            toggleSelection(); // 關閉選股視窗
        }


        async function fetchStockData(stockUrl) {
            try {
                const response = await fetch(`${stockUrl}?action=priceComparison`);
                const data = await response.json();
                return data;
            } catch (error) {
                console.error("Error fetching stock data:", error);
                throw error; // Optional: re-throw the error to propagate it
            }
        }

        async function updateStockData(stockUrl, priceElement, changeElement) {
            const stockData = await fetchStockData(stockUrl);
            if (stockData) {
                const lastPrice = stockData.latestPrice;
                const changePercent = ((stockData.latestPrice - stockData.oneHourAgoPrice) / stockData.oneHourAgoPrice) * 100;

                priceElement.textContent = lastPrice;
                changeElement.textContent = changePercent.toFixed(2) + "%";

                if (changePercent > 0) {
                    priceElement.classList.add("positive");
                    priceElement.classList.remove("negative", "neutral");
                    changeElement.classList.add("positive");
                    changeElement.classList.remove("negative", "neutral");
                } else if (changePercent < 0) {
                    priceElement.classList.add("negative");
                    priceElement.classList.remove("positive", "neutral");
                    changeElement.classList.add("negative");
                    changeElement.classList.remove("positive", "neutral");
                } else {
                    priceElement.classList.add("neutral");
                    priceElement.classList.remove("positive", "negative");
                    changeElement.classList.add("neutral");
                    changeElement.classList.remove("positive", "negative");
                }
            }
        }



        function fetchOrders() {
            showLoading();
            var url = `${placeOrderurl}?action=queryOrders&user=${user}`;
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    var container = document.getElementById('order-container');
                    container.innerHTML = '';
                    if (data.length === 0) {
                        hideLoading();
                        container.innerHTML = '<p>暫無委託</p>';
                    } else {
                        hideLoading();
                        data.forEach(stock => {
                            let stockName = '';
                            if (stock[1] === '5268.TW') {
                                stockName = 'Close AI'
                            } else if (stock[1] === '2331.TW') {
                              stockName = '台積雷'
                            } else if (stock[1] === '1975.TW') {
                                stockName = 'Macrosoft'
                            } else if (stock[1] === '2383.TW') {
                                stockName = '黃達'
                            } else if (stock[1] === '1923.TW') {
                                stockName = '迪土尼'
                            }
                            var quantity = stock[3];
                            var price = stock[4];
                            var status = stock[5];
                            var stockHtml = `
                                <div class="stock-info">
                                    <div class="stock-number">
                                        <span class="current-stock">${stock[6]}</span>
                                        <span class="stock-name">${stock[1]}</span>
                                    </div>
                                    <h2>${stockName}</h2>
                                    <div class="info-row">
                                        <span class="info-label">委託股數</span>
                                        <span class="info-value">${quantity}</span>
                                    </div>
                                    <div class="info-row">
                                        <span class="info-label">委託價格</span>
                                        <span class="info-value">${price}</span>
                                    </div>
                                    <div class="info-row">
                                        <span class="info-label">委託狀態</span>
                                        <span class="info-value">${status}</span>
                                    </div>
                                </div>`;
                            container.innerHTML += stockHtml;
                        });
                    }
                    toggleOrder();
                });
        }


        function showMessage(messageText, className) {
            const existingMessage = document.querySelector('.message');
            if (existingMessage) {
                document.body.removeChild(existingMessage);
            }
            const message = document.createElement('div');
            message.className = `message ${className}`;
            message.textContent = messageText;
            document.body.appendChild(message);

            setTimeout(() => {
                message.style.opacity = '0';
                setTimeout(() => {
                    document.body.removeChild(message);
                }, 1000); // 1秒後移除元素
            }, 1000); // 1秒後開始淡出
        }

        function updateBalance() {
            if (username) { // 如果用戶已登入
                balance = Math.round(balance * 100) / 100;
                document.getElementById('balance').textContent = numberWithCommas(Math.round(balance));
            } else {
                document.getElementById('balance').textContent = '請先註冊或登入';
            }
        }

        document.querySelector('.button-buy').addEventListener('click', function() {
            placeOrder('buy');
        });

        document.querySelector('.button-sell').addEventListener('click', function() {
            placeOrder('sell');
        });

        function placeOrder(type) {
            if (placingOrders) {
                return;
            }
            if (!user) {
                showMessage('請先登入', 'alert-info');
                return;
            }

            const price = parseFloat(document.getElementById('price-input').value);
            let quantity = parseInt(document.getElementById('quantity-input').value);
            const unit = document.getElementById('unit-label').innerText;
            if (unit === '張') {
                quantity *= 1000;
            }
            if (type === 'sell') {
                quantity = -quantity;
            }

            const estimatedAmount = parseFloat(document.getElementById('estimated-amount').innerText.replace(/,/g, ''));

            if (type === 'buy' && estimatedAmount > balance) {
                showMessage('餘額不足', 'alert-info');
                return;
            }
            showLoading()
            fetch(`${placeOrderurl}?action=placeOrder&user=${user}&symbol=${symbol}&quantity=${quantity}&price=${price}&orderType=${orderType}`)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'Order placed successfully') {
                        showSuccess();
                        //hideLoading();
                        // showMessage('訂單提交成功！', 'cashout-info');
                    } else {
                        showMessage('訂單提交失敗！', 'alert-info');
                    }
                });
            placingOrders = false;
        }



        leverageButton.addEventListener('click', () => {
            leverageModal.style.display = 'flex';
            setTimeout(() => {
                leverageModal.classList.add('show');
            }, 10); // 微小的延遲，讓瀏覽器有時間應用 display 屬性
            currentValue = selectedValue;
            modalValueElement.textContent = `${currentValue.toFixed(2)}x`;
            modalCurrentElement.textContent = `當前 ${selectedValue.toFixed(2)}x`;

            // 確保選中的倍率有正確的CSS class
            const selectedElement = document.querySelector('.selected');
            if (selectedElement) {
                selectedElement.classList.remove('selected');
            }
            Array.from(modalMultipliersElement.children).forEach(multiplier => {
                if (parseFloat(multiplier.textContent) === currentValue) {
                    multiplier.classList.add('selected');
                    multiplier.scrollIntoView({ behavior: 'smooth', inline: 'center' });
                }
            });
        });


        modalClose.addEventListener('click', () => {
            leverageModal.classList.remove('show');
            setTimeout(() => {
                leverageModal.style.display = 'none';
            }, 300); // 與 CSS transition 時間一致，確保淡出完成後隱藏視窗
        });

        modalConfirm.addEventListener('click', () => {
            selectedValue = currentValue;
            leverageButton.textContent = `${selectedValue.toFixed(2)}x`;
            leverageModal.classList.remove('show');
            updateEstimatedAmount();
            if(onMargin){
                orderType = `融資${currentValue}×`;
            }
            setTimeout(() => {
                leverageModal.style.display = 'none';
            }, 300); // 與 CSS transition 時間一致，確保淡出完成後隱藏視窗
        });

        function updateModalValue(newValue) {
            currentValue = newValue;
            modalValueElement.textContent = `${newValue.toFixed(2)}x`;
            const selectedElement = document.querySelector('.selected');
            if (selectedElement) {
                selectedElement.classList.remove('selected');
            }
            Array.from(modalMultipliersElement.children).forEach(multiplier => {
                if (parseFloat(multiplier.textContent) === newValue) {
                    multiplier.classList.add('selected');
                    multiplier.scrollIntoView({ behavior: 'smooth', inline: 'center' });
                }
            });
        }


        modalDecrementButton.addEventListener('click', () => {
            if (currentValue > 1) updateModalValue(currentValue - 1);
        });

        modalIncrementButton.addEventListener('click', () => {
            if (currentValue < 100) updateModalValue(currentValue + 1);
        });

        Array.from(modalMultipliersElement.children).forEach(multiplier => {
            multiplier.addEventListener('click', () => {
                const newValue = parseFloat(multiplier.textContent);
                updateModalValue(newValue);
            });
        });

        function toggleSlide(direction) {
            var slider = document.getElementById('slider');
            var unitLabel = document.getElementById('unit-label');
            if (direction === 'left') {
                slider.style.left = '2%';
                unitLabel.innerText = '張';
            } else {
                slider.style.left = '52%';
                unitLabel.innerText = '股';
            }
            updateEstimatedAmount();
        }

        function toggleMargin(direction) {
            var slider = document.getElementById('margin-slider');
            if (direction === 'left') {
                slider.style.left = '1%';
                orderType = '現股';
                onMargin = false;
            } else if (direction === 'middle') {
                slider.style.left = '34.3333333333%';
                orderType = `融資${currentValue}×`;
                onMargin = true;
            } else {
                slider.style.left = '67.6666666666%';
                orderType = '融券';
                onMargin = false;
            }
            updateEstimatedAmount();  // 在這裡添加這一行來確保更新預估價格
        }


        function adjustPrice(direction) {
            var priceInput = document.getElementById('price-input');
            var price = parseFloat(priceInput.value);
            if (price < 10) {
                price += direction * 0.01;
            } else if (price < 50) {
                price += direction * 0.05;
            } else if (price < 100) {
                price += direction * 0.1;
            } else if (price < 500) {
                price += direction * 0.5;
            } else if (price < 1000) {
                price += direction * 1;
            } else {
                price += direction * 5;
            }
            if (price < 0) price = 0;
            priceInput.value = price.toFixed(2);
            updateEstimatedAmount();
        }

        function adjustQuantity(direction) {
            var quantityInput = document.getElementById('quantity-input');
            var quantity = parseInt(quantityInput.value);
            quantity += direction;
            if (quantity <= 0) quantity = 1;
            quantityInput.value = quantity;
            updateEstimatedAmount();
        }

        function updateEstimatedAmount() {
            var price = parseFloat(document.getElementById('price-input').value);
            var quantity = parseInt(document.getElementById('quantity-input').value);
            var unit = document.getElementById('unit-label').innerText;
            var estimatedAmount = price * quantity;
            if (unit === '張') {
                estimatedAmount *= 1000;
            }
            if (orderType.includes('融資')) {  // 檢查 orderType 是否包含「融資」
                estimatedAmount /= currentValue;
            }
            document.getElementById('estimated-amount').innerText = numberWithCommas(trimTrailingZeros(estimatedAmount.toFixed(2)));
        }


        function trimTrailingZeros(numStr) {
            return numStr.replace(/(\.\d*[1-9])0+$/, "$1").replace(/\.0+$/, "");
        }

        function numberWithCommas(x) {
            return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }

        document.getElementById('price-input').addEventListener('input', function() {
            var priceInput = document.getElementById('price-input');
            var price = parseFloat(priceInput.value);
            if (isNaN(price) || price < 0) {
                priceInput.value = 0;
            } else {
                priceInput.value = price.toFixed(2);
            }
            updateEstimatedAmount();
        });

        document.getElementById('quantity-input').addEventListener('input', function() {
            var quantityInput = document.getElementById('quantity-input');
            var quantity = parseInt(quantityInput.value);

            if (isNaN(quantity) || quantity < 1) {
                quantityInput.value = 1;
            }
            updateEstimatedAmount();
        });

        
        


        function detectDevToolsAndRespond() {
        let devtools = false;
        const threshold = 160;

        function stopExecution() {
            document.body.innerHTML = '<h1>你不可以作弊😡</h1>';
            setTimeout(function() {
            window.location.href = 'https://youtu.be/dQw4w9WgXcQ';
            }, 2000);
        }

        function isMobile() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        }

        function checkDevTools() {
            const widthThreshold = window.outerWidth - window.innerWidth > threshold;
            const heightThreshold = window.outerHeight - window.innerHeight > threshold;
            
            if (
            !(widthThreshold && heightThreshold) &&
            ((window.Firebug && window.Firebug.chrome && window.Firebug.chrome.isInitialized) || widthThreshold || heightThreshold)
            ) {
            if (!devtools) {
                devtools = true;
                stopExecution();
            }
            } else {
            devtools = false;
            }
        }

        if (!isMobile()) {
            // 每秒檢查一次
            setInterval(checkDevTools, 1000);
        } else {
            console.log('在移動設備上，不執行開發者工具檢測');
        }
        }

        // 使用方法
        detectDevToolsAndRespond();

    </script>
</body>
</html>
